import os
import cv2
import numpy as np
from collections import defaultdict
from tqdm import tqdm  # éœ€è¦å…ˆå®‰è£…ï¼špip install tqdm


#æ£€æŸ¥æ–‡ä»¶å¤¹å†…å›¾ç‰‡å…±æœ‰å¤šå°‘ç§rgb
# é¢„å®šä¹‰é¢œè‰²æ˜ å°„è¡¨ (BGR æ ¼å¼)
color_map = {
    (0, 0, 0): 0,  # èƒŒæ™¯
    (255, 255, 0): 1,  # é“è·¯
    (0, 0, 255): 2,  # æ°´ä½“
    (255, 0, 0): 3,  # å»ºç­‘
    (0, 255, 0): 4  # æ¤è¢«
}


def color_statistics(folder_path):
    """
    ç»Ÿè®¡æ–‡ä»¶å¤¹å†…æ‰€æœ‰å›¾ç‰‡çš„é¢œè‰²åˆ†å¸ƒï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
    """
    # è·å–æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶åˆ—è¡¨
    file_list = [
        f for f in os.listdir(folder_path)
        if f.lower().endswith(('.png', '.jpg', '.jpeg', '.tif', '.tiff'))
    ]

    total_colors = defaultdict(int)
    defined_colors = defaultdict(int)
    undefined_colors = defaultdict(int)
    error_files = []

    # åˆ›å»ºè¿›åº¦æ¡
    with tqdm(total=len(file_list),
              desc="å¤„ç†è¿›åº¦",
              unit="æ–‡ä»¶",
              bar_format="{l_bar}{bar}| {n_fmt}/{total_fmt} [{elapsed}<{remaining}]") as pbar:

        for filename in file_list:
            file_path = os.path.join(folder_path, filename)
            try:
                img = cv2.imread(file_path)
                if img is None:
                    raise ValueError("æ— æ³•è¯»å–å›¾åƒæ•°æ®")

                # é¢œè‰²ç»Ÿè®¡
                pixels = img.reshape(-1, 3)
                for pixel in pixels:
                    pixel_tuple = tuple(pixel)
                    total_colors[pixel_tuple] += 1

                    if pixel_tuple in color_map:
                        defined_colors[pixel_tuple] += 1
                    else:
                        undefined_colors[pixel_tuple] += 1

                # æ›´æ–°è¿›åº¦æ¡æè¿°
                pbar.set_postfix({
                    "å½“å‰æ–‡ä»¶": filename[:15] + "..." if len(filename) > 15 else filename,
                    "æ€»é¢œè‰²æ•°": len(total_colors)
                })

            except Exception as e:
                error_files.append((filename, str(e)))

            # æ›´æ–°è¿›åº¦
            pbar.update(1)

    return dict(total_colors), dict(defined_colors), dict(undefined_colors), error_files


def print_color_report(total, defined, undefined, errors):
    """æ‰“å°å¸¦æ ¼å¼çš„ç»Ÿè®¡æŠ¥å‘Š"""
    print("\n" + "=" * 50)

    # é”™è¯¯æ–‡ä»¶æ˜¾ç¤º
    if errors:
        print("\nâŒ é”™è¯¯æ–‡ä»¶åˆ—è¡¨ï¼š")
        for filename, reason in errors:
            print(f"  {filename}: {reason}")

    # ä¸»è¦ç»Ÿè®¡ä¿¡æ¯
    print("\nğŸ“Š ç»Ÿè®¡æ‘˜è¦ï¼š")
    print(f"æ€»å¤„ç†æ–‡ä»¶æ•°: {len(errors) + len(total)}")
    print(f"æˆåŠŸå¤„ç†æ–‡ä»¶: {len(total)}")
    print(f"å¤±è´¥æ–‡ä»¶æ•°: {len(errors)}")
    print(f"å‘ç°é¢œè‰²æ€»æ•°: {len(total)} ç§")
    print(f"å·²å®šä¹‰é¢œè‰²: {len(defined)} ç§")
    print(f"æœªå®šä¹‰é¢œè‰²: {len(undefined)} ç§")

    # è¯¦ç»†é¢œè‰²åˆ†å¸ƒ
    print("\nğŸ¨ å·²å®šä¹‰é¢œè‰²åˆ†å¸ƒï¼š")
    for color in color_map:
        count = defined.get(color, 0)
        print(f"  â–ˆâ–ˆâ–ˆ BGR: {str(color):<15} â†’ ç±»åˆ« {color_map[color]:<2} â†’ åƒç´ æ•°: {count:,}")

    # æœªå®šä¹‰é¢œè‰²è­¦å‘Š
    if undefined:
        print("\nâš ï¸ æœªå®šä¹‰é¢œè‰²è­¦å‘Šï¼ˆæŒ‰å‡ºç°é¢‘ç‡æ’åºï¼‰ï¼š")
        for color, count in sorted(undefined.items(), key=lambda x: -x[1]):
            print(f"  â–’â–’â–’ BGR: {str(color):<15} â†’ åƒç´ æ•°: {count:,}")


# ä½¿ç”¨ç¤ºä¾‹
folder_path = r"C:\Users\ruyuz\Desktop\EAGLE-main\src_EAGLE\pytorch_data_dir\FUSAR\labelcolor"

total_colors, defined_colors, undefined_colors, error_files = color_statistics(folder_path)
print_color_report(total_colors, defined_colors, undefined_colors, error_files)
